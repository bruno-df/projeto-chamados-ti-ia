{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilo da Área do Chat */
    #chat-box {
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow-y: auto;
        padding: 20px;
        background-color: #fff;
        margin-bottom: 15px;
    }

    .mensagem {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 70%;
        line-height: 1.4;
    }

    /* Balão do Usuário (Direita, Azul) */
    .msg-user {
        background-color: #3498db;
        color: white;
        margin-left: auto;
        /* Empurra para direita */
        border-bottom-right-radius: 0;
    }

    /* Balão da IA (Esquerda, Cinza) */
    .msg-ia {
        background-color: #ecf0f1;
        color: #2c3e50;
        margin-right: auto;
        /* Empurra para esquerda */
        border-bottom-left-radius: 0;
    }

    .input-area {
        display: flex;
        gap: 10px;
    }
</style>

<h2>Assistente Virtual IA</h2>
<p>Descreva seu problema. A IA tentará ajudar ou abrirá um chamado para você.</p>

<div id="chat-box">
    <div class="mensagem msg-ia">
        Olá! Sou a IA do Suporte. Qual é o seu nome e em que setor você trabalha?
    </div>
</div>

<div class="input-area">
    <input type="text" id="user-input" placeholder="Digite sua mensagem..." onkeypress="handleEnter(event)">
    <button class="btn btn-primary" onclick="enviarMensagem()">Enviar</button>
</div>

<script>
    function handleEnter(e) {
        if (e.key === 'Enter') enviarMensagem();
    }

    async function enviarMensagem() {
        const input = document.getElementById('user-input');
        const texto = input.value.trim();
        if (!texto) return;

        // 1. Adiciona a mensagem do usuário na tela
        adicionarBalao(texto, 'msg-user');
        input.value = ''; // Limpa o campo

        // 2. Envia para o Django (Backend)
        try {
            const response = await fetch("{% url 'processar_mensagem' %}", {
                method: 'POST',
                body: JSON.stringify({ 'mensagem': texto }),
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            // 3. Adiciona a resposta do sistema na tela
            adicionarBalao(data.resposta, 'msg-ia');

            // Se a resposta contiver "sucesso", mostra um botão para voltar
            if (data.resposta.includes("sucesso")) {
                setTimeout(() => {
                    const chatBox = document.getElementById('chat-box');
                    const link = document.createElement('div');
                    link.innerHTML = `<a href="{% url 'meus_chamados' %}" class="btn btn-success" style="width:100%; text-align:center; display:block; margin-top:10px;">Ver Meus Chamados</a>`;
                    chatBox.appendChild(link);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    document.getElementById('user-input').disabled = true;
                }, 1000);
            }

        } catch (error) {
            console.error('Erro:', error);
            adicionarBalao('Erro ao conectar com o servidor.', 'msg-ia');
        }
    }

    function adicionarBalao(texto, classe) {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `mensagem ${classe}`;
        div.innerText = texto;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; // Rola para baixo
    }
</script>
{% endblock %}